<!-- static/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Chatbot with RAG</title>
    <style>
      :root {
        --primary-color: #4f46e5;
        --secondary-color: #f3f4f6;
        --accent-color: #10b981;
        --text-color: #1f2937;
        --border-color: #e5e7eb;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f9fafb;
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 300px;
        background-color: white;
        border-right: 1px solid var(--border-color);
        padding: 20px;
        overflow-y: auto;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .upload-section {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        background-color: white;
      }

      .chat-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
        padding: 10px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
        max-width: 80%;
      }

      .user-message {
        background-color: var(--primary-color);
        color: white;
        margin-left: auto;
      }

      .assistant-message {
        background-color: var(--secondary-color);
        color: var(--text-color);
      }

      .chat-input {
        display: flex;
        gap: 10px;
      }

      input,
      textarea,
      button {
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
      }

      input[type="file"] {
        padding: 5px;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #4338ca;
      }

      button.delete {
        background-color: #ef4444;
      }

      button.delete:hover {
        background-color: #dc2626;
      }

      .session-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        background-color: var(--secondary-color);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .session-item.active {
        background-color: var(--primary-color);
        color: white;
      }

      .session-item:hover {
        background-color: #e5e7eb;
      }

      .session-item.active:hover {
        background-color: #4338ca;
      }

      .error {
        color: #ef4444;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        background-color: #fee2e2;
      }

      .success {
        color: #10b981;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        background-color: #d1fae5;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h2>Chat Sessions</h2>
        <button id="new-chat-btn">New Chat</button>
        <div id="sessions-list"></div>
      </div>

      <div class="main-content">
        <div class="upload-section">
          <h2>Upload PDF Files</h2>
          <form id="upload-form">
            <input type="file" id="pdf-files" accept=".pdf" multiple required />
            <button type="submit">Upload and Process</button>
          </form>
          <div id="upload-status"></div>
        </div>

        <div class="chat-section">
          <div class="chat-messages" id="chat-messages">
            <div class="message assistant-message">
              Welcome! Please upload PDF files to start chatting.
            </div>
          </div>

          <div class="chat-input">
            <input
              type="text"
              id="message-input"
              placeholder="Type your message..."
              disabled
            />
            <button id="send-btn" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;

      // DOM elements
      const uploadForm = document.getElementById("upload-form");
      const pdfFilesInput = document.getElementById("pdf-files");
      const uploadStatus = document.getElementById("upload-status");
      const sessionsList = document.getElementById("sessions-list");
      const chatMessages = document.getElementById("chat-messages");
      const messageInput = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");
      const newChatBtn = document.getElementById("new-chat-btn");

      // Event listeners
      uploadForm.addEventListener("submit", handleUpload);
      sendBtn.addEventListener("click", handleSendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleSendMessage();
      });
      newChatBtn.addEventListener("click", startNewChat);

      // Load sessions on page load
      document.addEventListener("DOMContentLoaded", loadSessions);

      // Functions
      async function handleUpload(e) {
        e.preventDefault();

        const files = pdfFilesInput.files;
        if (files.length === 0) {
          showStatus("Please select at least one PDF file", "error");
          return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append("files", files[i]);
        }

        if (currentSessionId) {
          formData.append("session_id", currentSessionId);
        }

        try {
          showStatus("Uploading and processing files...", "info");

          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Upload failed");
          }

          const data = await response.json();
          currentSessionId = data.session_id;

          showStatus(
            "Files uploaded and processed successfully! You can now chat with your documents.",
            "success"
          );
          messageInput.disabled = false;
          sendBtn.disabled = false;

          // Clear file input
          pdfFilesInput.value = "";

          // Reload sessions to include the new one
          loadSessions();

          // Load the current session messages
          loadSession(currentSessionId);
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
          console.error("Upload error:", error);
        }
      }

      async function handleSendMessage() {
        const message = messageInput.value.trim();
        if (!message || !currentSessionId) return;

        // Add user message to chat
        addMessageToChat("user", message);
        messageInput.value = "";

        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              session_id: currentSessionId,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Chat failed");
          }

          const data = await response.json();
          addMessageToChat("assistant", data.response);
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
          addMessageToChat(
            "assistant",
            "Sorry, I encountered an error processing your request."
          );
          console.error("Chat error:", error);
        }
      }

      function addMessageToChat(role, content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}-message`;
        messageDiv.textContent = content;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showStatus(message, type) {
        uploadStatus.textContent = message;
        uploadStatus.className = type;
      }

      async function loadSessions() {
        try {
          const response = await fetch("/sessions");
          if (!response.ok) {
            throw new Error("Failed to load sessions");
          }

          const sessions = await response.json();
          sessionsList.innerHTML = "";

          sessions.forEach((session) => {
            const sessionItem = document.createElement("div");
            sessionItem.className = "session-item";
            if (session.id === currentSessionId) {
              sessionItem.classList.add("active");
            }

            sessionItem.innerHTML = `
                        <div>${session.name}</div>
                        <button class="delete" onclick="deleteSession('${session.id}', event)">Ã—</button>
                    `;

            sessionItem.addEventListener("click", () =>
              loadSession(session.id)
            );
            sessionsList.appendChild(sessionItem);
          });
        } catch (error) {
          console.error("Error loading sessions:", error);
        }
      }

      async function loadSession(sessionId) {
        try {
          const response = await fetch(`/sessions/${sessionId}`);
          if (!response.ok) {
            throw new Error("Failed to load session");
          }

          const session = await response.json();
          currentSessionId = sessionId;

          // Update UI to show active session
          document.querySelectorAll(".session-item").forEach((item) => {
            item.classList.remove("active");
          });

          document.querySelectorAll(".session-item").forEach((item) => {
            if (item.textContent.includes(session.name)) {
              item.classList.add("active");
            }
          });

          // Clear chat and load session messages
          chatMessages.innerHTML = "";
          session.messages.forEach((msg) => {
            addMessageToChat(msg.role, msg.content);
          });

          // Enable chat if the session has documents
          if (session.messages.length > 0 || true) {
            // Simplified check
            messageInput.disabled = false;
            sendBtn.disabled = false;
          }
        } catch (error) {
          showStatus(`Error loading session: ${error.message}`, "error");
          console.error("Error loading session:", error);
        }
      }

      async function deleteSession(sessionId, event) {
        event.stopPropagation(); // Prevent loading the session we're about to delete

        if (!confirm("Are you sure you want to delete this chat session?")) {
          return;
        }

        try {
          const response = await fetch(`/sessions/${sessionId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Delete failed");
          }

          // If we deleted the current session, reset the UI
          if (sessionId === currentSessionId) {
            currentSessionId = null;
            chatMessages.innerHTML =
              '<div class="message assistant-message">Welcome! Please upload PDF files to start chatting.</div>';
            messageInput.disabled = true;
            sendBtn.disabled = true;
          }

          // Reload sessions list
          loadSessions();
        } catch (error) {
          showStatus(`Error deleting session: ${error.message}`, "error");
          console.error("Error deleting session:", error);
        }
      }

      function startNewChat() {
        currentSessionId = null;
        pdfFilesInput.value = "";
        chatMessages.innerHTML =
          '<div class="message assistant-message">Welcome! Please upload PDF files to start chatting.</div>';
        messageInput.disabled = true;
        sendBtn.disabled = true;

        // Remove active class from all sessions
        document.querySelectorAll(".session-item").forEach((item) => {
          item.classList.remove("active");
        });
      }
    </script>
  </body>
</html>
